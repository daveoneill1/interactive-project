var news_obj = {};
news_obj.lists = [
                    {
                        id:"a4db5f2336",
                        name:"Carl M. Cannon's Morning Note",
                        site:"politics"
                    },{
                        id:"d6a76c9ec3",
                        name: "RCP Daily Poll Wrap-Up",
                        site:"politics"
                    },{
                        id:"51f930c5ce",
                        name: "RCP Today",
                        site:"politics"
                    },{
                        id:"8c65b915a9",
                        name: "RCP Morning Reel",
                        site:"politics"
                    },{
                        id:"9da46952f0",
                        name: "RCP Events",
                        site:"politics"
                    },{
                        id:"694f73a8dc",
                        name: "Defense Morning Recon",
                        site:"defense"
                    },{
                        id:"267b89dc8a",
                        name: "Science News",
                        site:"science"
                    },{
                        id:"462961a8ae",
                        name: "RealClearEnergy Morning Volt",
                        site:"energy"
                    },{
                        id:"d519acabbf",
                        name: "World News",
                        site:"world"
                    },{
                        id:"8a051b373b",
                        name: "Education Today",
                        site:"education"
                    },{
                        id:"b4baf6b587",
                        name: "RealClearHealth Morning Scan",
                        site:"health"
                    },{
                        id:"113ee1bc69",
                        name: "Weekly Policy Picks",
                        site:"policy"
                    },{
                        id:"113ee1bc69",
                        name: "RealClearPolicy",
                        site:"policy"
                    },{
                        id:"7f0a4512a1",
                        name: "RealClearReligion Today",
                        site:"religion"
                    },{
                        id:"ea772b1135",
                        name: "RealClearBooks Today",
                        site:"books"
                    },{
                        id:"fbced764bd",
                        name: "RealClearHistory Today",
                        site:"history"
                    },{
                        id:"1f71a1eaa2",
                        name: "RealClearMarkets Today",
                        site:"markets"
                    },{
                        id:"d042379c8d",
                        name: "RealClearInvestigations Today",
                        site:"investigations"
                    },{
                        id:"7d83b1601b",
                        name: "RealClear Originals",
                        site:"politics"
                    }
                ];

news_obj.inline_found = false;
news_obj.submitted = false;

loadFormHTML();

setFormTriggers();

function loadFormHTML(){

    //BUILD FORM HTML FOR PAGE. CSS IN master.css 
    var html_data = '<ul class="newsletters">';

    // Carl M. Cannon's Morning Note
    html_data += '<li class="newsletter-select odd politics" id="a4db5f2336"><span id="list_a4db5f2336" class="other_list" rel="Carl Cannon\'s Morning Note"><a title="Morning Note Archives" href="http://www.realclearpolitics.com/topic/r/RCP_Morning_Note/">Carl M. Cannon\'s Morning Note</a></span><span class="checkbox">&#10003;</span></li>';

    // RCP Today
    html_data += '<li class="newsletter-select even politics" id="51f930c5ce"><span id="list_51f930c5ce" class="other_list" rel="RCP Today"> <a href="http://us7.campaign-archive2.com/?u=61572bb8acf7b8704903af7b8&id=8bcbb3d2f9&e=[UNIQID]" title="View Preview">RCP Today</a> </span><span class="checkbox">&#10003;</span></li>';

    // Events
    html_data += '<li class="newsletter-select odd politics" id="9da46952f0"><span id="list_9da46952f0" class="other_list" rel="RCP Events"><a href="http://www.realclearpolitics.com/events/" title="RCP Events">RCP Events</a></span><span class="checkbox">&#10003;</span></li>';

    // Investigations
    html_data += '<li class="newsletter-select even investigations" id="d042379c8d"><span id="list_d042379c8d" class="other_list" rel="RealClearInvestigations Today">RealClearInvestigations Today</span><span class="checkbox">&#10003;</span></li>';

    // Morning Volt
    // With link
    // html_data += '<li class="newsletter-select odd energy" id="462961a8ae"><span id="list_462961a8ae" class="other_list" rel="RealClearEnergy Morning Volt"><a href="http://us7.campaign-archive2.com/?u=61572bb8acf7b8704903af7b8&id=6dc532adf1&e=[UNIQID]" title="View Preview">RealClearEnergy Morning Volt</a></span><span class="checkbox">&#10003;</span></li>';
    html_data += '<li class="newsletter-select odd energy" id="462961a8ae"><span id="list_462961a8ae" class="other_list" rel="RealClearEnergy Morning Volt">RealClearEnergy Morning Volt</span><span class="checkbox">&#10003;</span></li>';

    // Morning Recon
    html_data += '<li class="newsletter-select even defense" id="694f73a8dc"><span id="list_694f73a8dc" class="other_list" rel="Defense Morning Recon"> <a title="Morning Recon Archives" href="https://www.realcleardefense.com/weekly_recon/">RCD Morning Recon</a> </span><span class="checkbox">&#10003;</span></li>';

    // World News
    html_data += '<li class="newsletter-select odd world" id="d519acabbf"><span id="list_d519acabbf" class="other_list" rel="World News">World News</span><span class="checkbox">&#10003;</span></li>';

    // Markets
    html_data += '<li class="newsletter-select even markets" id="1f71a1eaa2"><span id="list_1f71a1eaa2" class="other_list" rel="RealClearMarkets Today">RealClearMarkets Today</span><span class="checkbox">&#10003;</span></li>';

    // Education
    html_data += '<li class="newsletter-select odd education" id="8a051b373b"><span id="list_8a051b373b" class="other_list" rel="Education Today">Education Today</span><span class="checkbox">&#10003;</span></li>';

    // Science
    html_data += '<li class="newsletter-select even science" id="267b89dc8a"><span id="list_267b89dc8a" class="other_list" rel="Science News">Science News</span><span class="checkbox">&#10003;</span></li>';

    // Health
    html_data += '<li class="newsletter-select odd health" id="b4baf6b587"><span id="list_b4baf6b587" class="other_list" rel="RealClearHealth Morning Scan">RealClearHealth Morning Scan</span><span class="checkbox">&#10003;</span></li>';

    // Mideast
    html_data += '<li class="newsletter-select even nl-mideast" id="1630639ffc"><span id="list_1630639ffc" class="other_list" rel="RealClearWorld Mideast Memo Weekly">RealClearWorld Mideast Memo Weekly</span><span class="checkbox">&#10003;</span></li>';

    // Europe
    html_data += '<li class="newsletter-select odd nl-europe" id="9960d29f6a"><span id="list_9960d29f6a" class="other_list" rel="RealClearWorld Europe Memo Weekly">RealClearWorld Europe Memo Weekly</span><span class="checkbox">&#10003;</span></li>';

    // Religion
    html_data += '<li class="newsletter-select even religion" id="7f0a4512a1"><span id="list_7f0a4512a1" class="other_list" rel="RealClearReligion Today">RealClearReligion Today</span><span class="checkbox">&#10003;</span></li>';

    // History
    html_data += '<li class="newsletter-select odd books" id="fbced764bd"><span id="list_fbced764bd" class="other_list" rel="RealClearHistory Today">RealClearHistory Today</span><span class="checkbox">&#10003;</span></li>';

    // Books
    html_data += '<li class="newsletter-select even books" id="ea772b1135"><span id="list_ea772b1135" class="other_list" rel="RealClearBooks Today">RealClearBooks Today</span><span class="checkbox">&#10003;</span></li>';

    // Policy
    html_data += '<li class="newsletter-select odd policy" id="113ee1bc69"><span id="list_113ee1bc69" class="other_list" rel="RealClearPolicy Today">RealClearPolicy Today</span><span class="checkbox">&#10003;</span></li>';

    // Thomas Sowell
    html_data += '<li class="newsletter-select even nl-sowell" id="e166096ac1"><span id="list_e166096ac1" class="other_list" rel="Latest by Thomas Sowell">Thomas Sowell</span><span class="checkbox">&#10003;</span></li>';

    // Victor Davis Hanso
    html_data += '<li class="newsletter-select odd nl-hanson" id="328e384d1b"><span id="list_328e384d1b" class="other_list" rel="Latest by Victor Davis Hanson">Victor Davis Hanson</span><span class="checkbox">&#10003;</span></li>';

    // George Will
    html_data += '<li class="newsletter-select even nl-will" id="ede7e7aa35"><span id="list_ede7e7aa35" class="other_list" rel="Latest by George Will">George Will</span><span class="checkbox">&#10003;</span></li>';

    // John Stossel
    html_data += '<li class="newsletter-select odd nl-stossel" id="e6249bd7d1"><span id="list_e6249bd7d1" class="other_list" rel="Latest by John Stossel">John Stossel</span><span class="checkbox">&#10003;</span></li>';

    // Robert Samuelson
    html_data += '<li class="newsletter-select even nl-samuelson" id="a2132d4c3f"><span id="list_a2132d4c3f" class="other_list" rel="Latest by Robert Samuelson">Robert Samuelson</span><span class="checkbox">&#10003;</span></li>';

    // Unused
    // html_data += '<li class="newsletter-select even politics" id="8c65b915a9"><span id="list_8c65b915a9" class="other_list" rel="RCP Morning Reel sdfsdf"><a href="http://www.realclearpolitics.com/video/original/" title="RCP Morning Reel">RCP Morning Reel</a></span><span class="checkbox">&#10003;</span></li>';
    // html_data += '<li class="newsletter-select even politics" id="d6a76c9ec3"><span id="list_d6a76c9ec3" class="other_list" rel="RCP Daily Poll Wrap-Up"><a href="http://www.realclearpolitics.com/epolls/latest_polls/" title="RCP Daily Poll Wrap-Up">RCP Daily Poll Wrap-Up</a></span><span class="checkbox">&#10003;</span></li>';
    //html_data += '<li class="newsletter-select even politics" id="7d83b1601b"><span id="list_7d83b1601b" class="other_list" rel="RealClear Originals">RealClear Originals</span><span class="checkbox">&#10003;</span></li>';
    //html_data += '<li class="newsletter-select even world" id="9960d29f6a"><span id="list_9960d29f6a" class="other_list" rel="Europe Memo">Europe Memo</span><span class="checkbox">&#10003;</span></li>';
    //html_data += '<li class="newsletter-select odd world" id="1630639ffc"><span id="list_1630639ffc" class="other_list" rel="Mideast Memo">Mideast Memo</span><span class="checkbox">&#10003;</span></li>';
    // html_data += '<li class="newsletter-select odd policy" id="113ee1bc69"><span id="list_113ee1bc69" class="other_list" rel="Weekly Policy Picks">Weekly Policy Picks</span><span class="checkbox">&#10003;</span></li>';

    html_data += '</ul>';


    html_data += '<!-- newsletters-items -->';
    html_data += '<div class="signup-row"><input type="text" placeholder="Enter your email address" id="list_email" name="list_email" size="25"/>'
                    +'<span id="loader" style="display:none;"><img src="/images/ajax-loader2.gif" /></span>'
                    +'<input type="button" id="btn_subscribe" name="btn_subscribe" value="Submit" />'
                    +'<input type="hidden" name="zelda" id="zelda" />'
                    +'</div>'
                    +'<div id="think_email" class="think_email"></div>';
    html_data += '<div id="opt-in">';
    html_data += '<div class="i-agree"><div><input type="checkbox" id="i-agree" name="i-agree" value="1">I Agree</div></div>';
    html_data += '<div class="right-options">';
    html_data += '<div class="opt-in-item"><div class="newsletter-optin"><input type="checkbox" class="opt_in" id="opt_in_1" name="opt_in_1" value="1"></div> <div class="opt-in-text">Receive emails about new products & services?</div></div>';
    html_data += '<div class="opt-in-item"><div class="newsletter-optin"><input type="checkbox" class="opt_in" id="opt_in_2" name="opt_in_2" value="1"></div> <div class="opt-in-text">Receive emails from partners & advertisers?</div></div>';
    html_data += '<div class="opt-in-item"><div class="newsletter-optin"><input type="checkbox" class="opt_in" id="opt_in_3" name="opt_in_3" value="1"></div> <div class="opt-in-text">Agree to Privacy Policy</div></div></form>';
    html_data += '</div>'; //end of right options div
    html_data += '</div>';

    //APPENDS HTML FORM INTO PARENT ELEMENT
    //$('.jsTag').last().parent().append(html_data);
    $('.newsletter-signup-container2').html(html_data);

    $('.newsletter-signup-container2').each(function() {

        //GETS DATA-AUTO-CHECKS ATTRIBUTE FROM JS EMBED
        var att = $(this).attr('data-auto-checks');
        var auto_checks = [];
        if(typeof att !== 'undefined') {
          auto_checks = att.split("|"); //SPLITS INTO ARRAY
        }

        //LOOP THROUGH ALL NEWSLETTER CHECKBOXES
        if(auto_checks.length > 0){
            
            for (var i=0; i<auto_checks.length; i++) {
                //IF STRING IS EMPTY, SKIP THAT THANG
                if(auto_checks[i].length == 0){
                    continue;
                }

                $(this).find("#"+auto_checks[i]+".newsletter-select").addClass("selected");
            }
        }

        //CHECKBOX CLICK HANDLER
        $(this).find("span.checkbox").click(function() {
            $(this).parent().toggleClass('selected');
        });

        // Show opt-in checkboxes when email input is focused
        $(this).find('#list_email').focus(function()
        {
            if(!this.emptied) {
                this.value = '';
                this.emptied = 1;
                $(this).parent().parent().find('div#opt-in').show();
            }

            //if it found the inline sign up box
            if($(this).parents('.inline_sign_up_box').length){

                $('.think_email').hide();

                $('.inline_sign_up_box ul.newsletters li.'+ siteName).css('display', 'table');
                var items_height = $('.inline_sign_up_box ul.newsletters').height();
            
                if( ($(window).width() > 1023 && !$('body').hasClass('article')) || ($('body').hasClass('article') && $(window).width() > 1180) ){
                    var inline_sign_up_box_height = parseInt(items_height)+70;
                }else{
                    var inline_sign_up_box_height = parseInt(items_height)+265; //190
                }
            
                $(this).parents('.inline_sign_up_box').css('height', inline_sign_up_box_height+'px').addClass('sign_up_open');
                news_obj.inline_found = true;

                if( (news_obj.submitted == true && $(window).width() < 1024) 
                    || (news_obj.submitted == true && $('body').hasClass('article') && $(window).width() <= 1180) ){
                    news_obj.submit_added
                    var current_top = parseInt($('.inline_sign_up_box ul.newsletters').css('top'));
                    var new_top = current_top - news_obj.submit_added;
                    $('.inline_sign_up_box ul.newsletters').css('top', new_top+'px');
                    news_obj.submitted = false;
                }
            }
        });
    });

    showNewsWidget();
}

function setFormTriggers(){
    //$("#list_email").val('Enter your email address');

    //BUTTON CLICK
    $('.newsletter-signup-container2').find("#btn_subscribe").click(function() {
        validateForm_v2($(this).parent().parent());
    });

    //ENTER KEY
    $('.newsletter-signup-container2').find('#list_email').bind('keypress', function(e) {
        if(e.keyCode==13){
            validateForm_v2($(this).parent().parent());
        }
    });

    //EMAIL FOCUS SHOW OPTIONS
    $('.newsletter-signup-container2').find('#list_email').focus(function(){
        $(this).parent().parent().find( "#opt-in" ).slideDown();
    });
}

function showNewsWidget(){
    $(".jQ-news-widget").unbind('click');
	$(".jQ-news-widget").click(function(){
		//console.log("fired...");
		var elem = $(this).parent().next(".newsletter-signup-container2");
		
		//elem.toggle();

        //console.log(elem.is(':visible'));
		
		if( elem.is(':visible') ) {
		  elem.hide();
		} else {
		  elem.show();
		}
	});
}

function validateForm_v2(target_parent){

    var e = target_parent.find('input[name="list_email"]').val();
    //console.log('here1');
    //console.log(e);
    if($('#opt_in_3').prop('checked') == false){

        target_parent.find('#think_email').html('Please Agree to the Terms of Service.').show();

        if($('#i-agree').prop('checked')){
            $('#opt_in_3').focus();
        }else{
            $('#i-agree').focus();
        }

        target_parent.find('#think_subscribe').html('');
    }
    else if(validEmail(e)){
        //console.log('here2');
        target_parent.find('#think_email').html('').hide();
        sendSubscribe_v2(target_parent);
    }else{
        //console.log('here3');
        target_parent.find('#think_email').html('Please enter a valid email address.').show();
        target_parent.find('#think_subscribe').html('');
    }
}

function validEmail(email){
    var emailReg = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,4}$/;
    return emailReg.test(email);
}

//SUBMIT FORM AND SUBSCRIBE TO EACH SELECTED NEWSLETTER
function sendSubscribe_v2(target_parent){

    target_parent.find('#loader').show();

    if(news_obj.inline_found == true){
        target_parent.find('#btn_subscribe').hide();
    }

    var opt_in_1 = target_parent.find("#opt-in input#opt_in_1").is(':checked');
    var opt_in_2 = target_parent.find("#opt-in input#opt_in_2").is(':checked');
    var opt_in_3 = target_parent.find('#opt-in input#opt_in_3').is(':checked');

    var api_lists = [];

    target_parent.find("li.newsletter-select.selected").each(function() {
            api_lists.push($(this).attr("id"));
    });


    if(api_lists.length>0){

        $.ajax({
            url: window.location.protocol+'//util.realclearpolitics.com/subscriptions/mailchimp_do_subscribe_v2.php?callback=?',
            data: 'zelda='+target_parent.find("#zelda").val()+'&list_email='+target_parent.find("#list_email").val()+'&lists='+api_lists+'&optin1='+opt_in_1+'&optin2='+opt_in_2+'&optin3='+opt_in_3+'&loc='+target_parent.find('.jsTag').attr('data-loc')+'',
            dataType: 'jsonp',
            jsonpCallback: 'myData',
            cache: false,
            context: {
              target_parent_ref: target_parent
            },
            success: function(y) {

                var target_parent = this.target_parent_ref;
                var subscribe_output = '';
                api_lists_subscribed = new Array();
                api_lists_already_subscribed = new Array();

                for(var key in y.data.content){ //STEPS THROUGH EACH CHECKED LIST

                    var vars = y.data.content[key].split("|");
                    var status = vars[0];
                    var email = vars[1];
                    var list_id = vars[2];
                    var code = vars[3];
                    var message = vars[4];
                    var list_name = $('#list_'+list_id).attr('rel');

                    if(status!=1){
                        if(code==214){ //EMAIL ALREADY SUBSCRIBED TO LIST
                            //subscribe_output += '<p>Already subscribed to <b>'+list_name+'</b></p>';
                            api_lists_already_subscribed.push(list_name); //APPEND TO ALREADY SUBSCRIBED LIST
                        }else{
                            //console.log(message); 

                            subscribe_output += message;
                        } 
                    }else{ //SUCCESS
                        api_lists_subscribed.push(list_name); //APPEND TO SUCCESS LISTS ARR
                    }

                }

                //alert(api_lists_subscribed.length);
                if(api_lists_already_subscribed.length>0){

                    subscribe_output += '<p>Already subscribed to the following:</p> <ul>';

                    for ( var i = 0; i < api_lists_already_subscribed.length; i = i + 1 ) {
                        subscribe_output += '<li><b>&#8226; '+api_lists_already_subscribed[i]+'</b></li>';
                    }

                    subscribe_output += '</ul>';
                }

                if(api_lists_subscribed.length>0){
                    subscribe_output += '<p>Confirmation email shall arrive shortly for:</p> <ul class="success-subscibe-list">';
                    for ( var i = 0; i < api_lists_subscribed.length; i = i + 1 ) {
                        subscribe_output += '<li><b>&#8226; '+api_lists_subscribed[i]+'</b></li>';
                    }
                    subscribe_output += '</ul>';
                }

                
                target_parent.find('#list_email').val('');
                target_parent.find('#think_email').html('<div style="margin:0 10px;">'+subscribe_output+'</div>').show();
				//case: if is on mobile make the window higher 
				if($(window).width() <= 415){
					//var hight_response_ul = $('.newsletter-signup-container2').height();
					//var warning_wrapper = $('.warning-wrapper').height();
					//console.log(hight_response_ul);
					$('.warning-wrapper ul.newsletters').css({display: 'none'});
					$('.warning-wrapper #opt-in').hide();
				}
				
                target_parent.find('#loader').hide();
                if(news_obj.inline_found == true){
                    news_obj.submitted = true;
                    target_parent.find('#btn_subscribe').show();

                    if(($(window).width() < 1024 && !$('body').hasClass('body')) || ($('body').hasClass('article') && $(window).width() <= 1180)){
                        var start_height = $('.inline_sign_up_box').height();
                        var display_height = target_parent.find('.think_email').height();
                        var new_height = parseInt(start_height)+parseInt(display_height)+30;
                        $('.inline_sign_up_box').css('height', new_height+'px');

                        var current_top = parseInt($('.inline_sign_up_box ul.newsletters').css('top'));
                        var new_top = current_top+display_height+30;
                        news_obj.submit_added = display_height+30;
                        $('.inline_sign_up_box ul.newsletters').css('top', new_top+'px');
                    }
                }

            } //END SUCCESS FUNC
        }); //END AJAX
    } //END IF LISTS CHECK

}
